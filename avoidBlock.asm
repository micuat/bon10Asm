LIST
	INCLUDE p16f84a.inc

	__CONFIG _CP_OFF & _PWRTE_ON & _WDT_OFF & _XT_OSC

	CBLOCK	0x20
	CNT1
	CNT2
	CNT3
	CNT4
	TEMP
	ENDC

	ORG 0
MAIN
	BSF		STATUS,RP0
	MOVLW	000H
	MOVWF	OPTION_REG
	CLRF	INTCON
	MOVLW	B'11110000'
	MOVWF	TRISA
	MOVLW	B'00111100'
	MOVWF	TRISB
	BCF		STATUS,RP0
	MOVLW	B'00000011'
	MOVWF	PORTB

LOOP
; Debug: DIP to motor
;	MOVF	PORTB, W
;	MOVWF	TEMP
;	RRF		TEMP, f
;	RRF		TEMP, W
;	MOVWF	PORTA
	
	BTFSC	PORTB, 2
	GOTO	STANDBY

	MOVLW	B'00111111'
	ANDWF	PORTB, f	; set pb6 & pb7 blocked; if once its cleared, set 1
	CALL	ISRIGHTBLOCKED
	CALL	TIM10
	CALL	ISLEFTBLOCKED
	CALL	TIM10
	CALL	ISRIGHTBLOCKED
	CALL	TIM10
	CALL	ISLEFTBLOCKED
	CALL	TIM10

	BTFSS	PORTB, 7	; do if left is blocked
	GOTO	GORIGHT
	BTFSS	PORTB, 6	; do if right is blocked (0: blocked)
	GOTO	GOLEFT


	GOTO	GOSTRAIGHT


	GOTO	LOOP

STANDBY
	MOVLW	B'00000000'
	MOVWF	PORTA
	GOTO	LOOP
; STANDBY

GOLEFT
	MOVLW	B'00000110'
;	MOVLW	B'00000010'
	MOVWF	PORTA

	NOP
	MOVLW	0FFH
	MOVWF	CNT4
LEFTLP
	MOVF	PORTA, W
	MOVWF	TEMP
	BTFSC	TEMP, 0
	BCF		PORTA, 0
	BTFSS	TEMP, 0
	BSF		PORTA, 0
	CALL	TIM10
	DECFSZ	CNT4, f
	GOTO	LEFTLP

	GOTO	LOOP
; GOLEFT

GORIGHT
	MOVLW	B'00001001'
;	MOVLW	B'00000001'
	MOVWF	PORTA

	NOP
	MOVLW	0FFH
	MOVWF	CNT4
RIGHTLP
	MOVF	PORTA, W
	MOVWF	TEMP
	BTFSC	TEMP, 1
	BCF		PORTA, 1
	BTFSS	TEMP, 1
	BSF		PORTA, 1
	CALL	TIM10
	DECFSZ	CNT4, f
	GOTO	RIGHTLP

	GOTO	LOOP
; GORIGHT

GOSTRAIGHT
	MOVLW	B'00000011'
	MOVWF	PORTA
	CALL	TIM100
	GOTO	LOOP
; GOSTRAIGHT


ISRIGHTBLOCKED
	BSF		PORTB, 0
	CALL	LEDLP
	BCF		PORTB, 0
	CALL	LEDLP
	BSF		PORTB, 0
	CALL	LEDLP
	BCF		PORTB, 0
	CALL	LEDLP
	BSF		PORTB, 0
	CALL	LEDLP
	BCF		PORTB, 0
	CALL	LEDLP
	BSF		PORTB, 0
	CALL	LEDLP
	BCF		PORTB, 0
	CALL	LEDLP
	BSF		PORTB, 0
	CALL	LEDLP
	BCF		PORTB, 0
	CALL	LEDLP
	BSF		PORTB, 0
	CALL	LEDLP
	BCF		PORTB, 0
	CALL	LEDLP
	BSF		PORTB, 0
	CALL	LEDLP
	BCF		PORTB, 0
	CALL	LEDLP
	BSF		PORTB, 0
	CALL	LEDLP
	BCF		PORTB, 0
	CALL	LEDLP

	BTFSC	PORTA, 4	; skip if blocked
	BSF		PORTB, 6

;	BSF		PORTB, 6	; monitor off
;	BTFSS	PORTA, 4
;	BCF		PORTB, 6
	RETURN
; ISRIGHTBLOCKED

ISLEFTBLOCKED
	BSF		PORTB, 1
	CALL	LEDLP
	BCF		PORTB, 1
	CALL	LEDLP
	BSF		PORTB, 1
	CALL	LEDLP
	BCF		PORTB, 1
	CALL	LEDLP
	BSF		PORTB, 1
	CALL	LEDLP
	BCF		PORTB, 1
	CALL	LEDLP
	BSF		PORTB, 1
	CALL	LEDLP
	BCF		PORTB, 1
	CALL	LEDLP
	BSF		PORTB, 1
	CALL	LEDLP
	BCF		PORTB, 1
	CALL	LEDLP
	BSF		PORTB, 1
	CALL	LEDLP
	BCF		PORTB, 1
	CALL	LEDLP
	BSF		PORTB, 1
	CALL	LEDLP
	BCF		PORTB, 1
	CALL	LEDLP
	BSF		PORTB, 1
	CALL	LEDLP
	BCF		PORTB, 1
	CALL	LEDLP

	BTFSC	PORTA, 4	; skip if blocked
	BSF		PORTB, 7

;	BSF		PORTB, 7	; monitor off
;	BTFSS	PORTA, 4
;	BCF		PORTB, 7
	RETURN
; ISLEFTBLOCKED

LEDLP
	NOP
	MOVLW	004H
	MOVWF	CNT3	; so far 5+2
LEDLP1
	DECFSZ	CNT3, f
	GOTO	LEDLP1
	RETURN			; 3*n + (5+2) + 4 == 26

TIM10
	MOVLW	0C7H	;199
	MOVWF	CNT1
TIMLP1
	NOP
	NOP
	DECFSZ	CNT1,F
	GOTO	TIMLP1	;2+5*199-1=996
	RETURN		;996+2=998*0.4usec=0.4msec
TIM100
	MOVLW	0F9H	;249 
	MOVWF	CNT2
TIMLP2
	CALL	TIM10	;2+(1000+3)*249-1=249748
	DECFSZ	CNT2,F
	GOTO	TIMLP2
	RETURN

	END
